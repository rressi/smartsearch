# searchservice

It is a tool that loads a raw index - generated by [*makeindex*](makeindex.md) -
and implements a micro web service to search for documents.

It also provides other optional features:
- to serve also documents beside pure search.
- to host one web application from the filesystem.

The following demo-site it is hosted 100% by *searchservice*:
- [http://smartsearch.cc/](http://smartsearch.cc/)


## Method `/search`

It is the core method this tool is providing.

```sh
$ wget -o - http://localhost:5000/search?q=my+fancy+query
[10,345,2456]

$ wget -o - http://localhost:5000/search?q=my+fancy+query&l=2
[10,345]
```

It simply takes one query `/search` with the following parameters:
- `q`: a free text to be searched in the index.
- `l`: optionally the user can limit the number of results with this parameter.

It returns a sorted JSON list containing ids of matching documents, the same
 ids that were passed to *makeindex* when the index was generated.  

It can be launched in this way:

```sh
$ searchservice -i myindex.idx -p 5000
```

It can also be used in this way:

```sh
$ zcat inputstream.txt.gz | \
    makeindex -id i -content c | \
    searchservice -i myindex.idx -p 5000
```

Another side method `/rawIndex` can be used to take from the server the index
as a blob. It would be useful if the client application implements part of the
search locally. We plan to implement this class of features using JavaScript in 
the near future.


## Method `/docs`

If the tool is launched with a file containing a stream of documents as an 
input it is able to create an index at startup and then serving either the
method `/search` either a new method `/docs`.

```sh
$ searchservice -p 5000 -d documents.txt -id i -content c,t
```

With the above command we are telling *searchservice* to take a text file 
containing a stream of JSON documents:
- one document per line.
- every document is a JSON dictionary at the top level.

Note that:
- *searchservice* is able only to index values at the top level that are of 
  type string or numeric.
- *searchservice* requires a field with unique ids. This ids must be strictly
  positive integers.
- *searchservice* with method `/docs` is giving back the documents in lines that
  are binary identical to the ones found ont the original source.

Method `/docs` just get one parameter:

```sh
$ wget -o - http://localhost:5000/docs?ids=1+45+47
{"i"=1,"t"="Index this title please","c"="Some other content to index"}
{"i"=45,"t"="Index this other title please","c"="...again content to index"}
{"i"=47,"t"="Index this other title please","c"="...again content to index"}
```


## Method `/app`

On top of the other methods we have the opportunity to let *searchservice*
serve a website by passing a folder from the local file system containing some
web app.

It would serve files as they are found in the file system and would forbid
access to everything outside the given folder.

```sh
$ searchservice -p 5000 -d documents.txt -id i -content c,t -app /opt/fancy_web_app/
```

It also implement these necessary features:
- if the user requests `/app` or `/app/` it serves `/app/index.html`.
- if the user requests `/` it redirects the client to `/app`.


## Command line usage

```sh
$ ./searchservice.exe --help
Usage of searchservice:
  -app string
        optionally serves a static web app from this passed folder
  -content string
        Json attributes to be indexed, comma separated (default "content")
  -d string
        File containing all the documents
  -i string
        Raw index as input file (default "-")
  -id string
        Json attribute for document ids (default "id")
  -n string
        Optional TCP binding ip/name to reduce visibility of the service.
  -p uint
        TCP port to be used by the HTTP server. (default 5000)
```


## How to build

The first time you need to fetch the prerequisites, you can execute `init.sh` or
just do the following:

```sh
export GOPATH=$(pwd)
go get golang.org/x/text
```

It downloads and compiles `golang.org/x/text` that we use for text 
normalization.

Then to compile `searchservice` on your machine you can run `build.sh` or just 
type the following:

```sh
export GOPATH=$(pwd)
go build src/searchservice.go
```

The generated binary file should be placed in the root folder of the project.
